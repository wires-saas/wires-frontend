

<!-- Page title and return button-->
<div class="flex justify-content-between align-items-start mb-4 fadein animation-duration-200">

    <div>
        <h1 class="m-0">
            <!-- <button pButton pRipple type="button" [disabled]="true"
                    icon="pi pi-address-book"
                    class="p-button-icon-only p-button-rounded text-6xl mr-2 opacity-100">
                </button> -->

            Add Contacts
        </h1>

    </div>


    <a [routerLink]="['/organization/' + currentOrgSlug + '/audience/contacts']">
        <button pButton pRipple type="button"
                i18n-label
                label="Return to contact list"
                class="p-button p-button-primary p-button-outlined mb-2"></button>
    </a>


</div>


<div class="grid fadein animation-duration-200">
    <div class="col-12">
        <div *ngIf="step === 1"  class="card">
            <h4 i18n>Selection of CSV file</h4>
            <p i18n>
                Rows must include at least an email address.<br/>Next, we'll review the file and map the columns to database fields.
            </p>

            <p-fileUpload 
                mode="basic" 
                i18n-chooseLabel
                chooseLabel="Select File" 
                chooseIcon="pi pi-upload"
                name="demo[]"
                accept=".csv" 
                maxFileSize="1000000" (onSelect)="onFileSelected($event)" />

                
        </div>

        <div *ngIf="step === 2 && csvSummary" class="card">
            <h4 i18n>Review of CSV file</h4>
            <p i18n>
                In order to avoid creating unecessary columns, we'll only keep the ones that are mapped to a database field.<br/>
                For each column you can chose to :
            </p>

            <ul>
                <li>Ignore it</li>
                <li>Map it to an existing field</li>
                <li>Create a new field (with same name as the column or a custom name)</li>
            </ul>

            <p><strong>Rows:</strong> {{ csvSummary.rowCount }}</p>

            <p-table [value]="csvSummary.columns" [scrollable]="true" styleClass="p-datatable-lg">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Column</th>
                    <th>Action</th>
                    <th>Field Name</th>
                    <th>Field Type</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-col let-i="rowIndex">
                  <tr>
                    <td>{{ col.name }}</td>
                    <td>
                        <form [formGroup]="mappingForm">
                            <p-dropdown
                                [options]="actionOptions"
                                [formControlName]="'column-' + i + '-action'"
                                optionLabel="name" optionValue="value"
                                placeholder="Select an Action" styleClass="w-full"
                                appendTo="body"
                                />
                        </form>
                    </td>
                    <td>
                        <form *ngIf="notIgnoring(i)" [formGroup]="mappingForm">

                            <ng-container *ngIf="creatingNewField(i); else existingField">

                                <div class="p-input-icon-right w-full">
                                    <input type="text" pInputText [formControlName]="'column-' + i + '-new-field-name'" class="w-full" />
                                    <i class="pi pi-info-circle" pTooltip="No special characters allowed" tooltipPosition="bottom"></i>
                                </div>

                            </ng-container>

                            <ng-template #existingField>
                                <p-dropdown
                                    [options]="fieldOptions[i]"
                                    [formControlName]="'column-' + i + '-field'"
                                    optionLabel="name"
                                    optionValue="value"
                                    placeholder="Select a Field"
                                    styleClass="w-full"
                                    appendTo="body"
                                />
                            </ng-template>
                        </form>
                    </td>
                    <td>
                        <form *ngIf="notIgnoring(i)" [formGroup]="mappingForm">
                            <p-dropdown
                                [options]="typeOptions"
                                [formControlName]="'column-' + i + '-type'"
                                optionLabel="name"
                                optionValue="value"
                                placeholder="Select a Type"
                                styleClass="w-full"
                                appendTo="body"
                            />
                        </form>
                    </td>
                  </tr>
                </ng-template>
              </p-table>


              <div class="col-12">
                <p-messages [value]="messages"></p-messages>
              </div>
            

            <div class="col-12">
                <button pButton pRipple [disabled]="!mappingForm.valid || messages.length > 0" i18n-label label="Confirm Mapping" icon="pi pi-file-check" class="w-auto mt-1">
                </button>

                <button pButton type="button" label="Change file" (click)="reset()" class="p-button-primary p-button-text"></button>
            </div>
        </div>
    </div>
</div>