<p-toast position="bottom-right"></p-toast>
<div class="card">

    <h5 i18n>Available Tags</h5>

    <div class="flex mb-5">
        <p-tag *ngFor="let tag of tags"
               (click)="selectedTag && selectedTag._id === tag._id ? clear(dataTable) : loadTag(tag)"
               [severity]="tag.color"
               [value]="tag.displayName"
               [pTooltip]="tag.description"
               tooltipPosition="bottom"
               class="inline-block mx-2 cursor-pointer select-none"
               [class.opacity-20]="selectedTag && tag._id !== selectedTag._id" styleClass="p-2 w-full"></p-tag>
    </div>


    <h5 i18n>Articles ({{ articles.length }})</h5>
    <p-table #dataTable [value]="articles" dataKey="id" [rows]="10"
             [loading]="loading" [showLoader]="false"
             sortField="metadata.publishedAt" [sortOrder]="-1"
             [rowHover]="true" styleClass="p-datatable-gridlines"
             [paginator]="true" [globalFilterFields]="['metadata.title','metadata.description', 'metadata.categories']" responsiveLayout="scroll">
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between flex-column sm:flex-row">
                <button pButton i18n-label label="Clear" class="p-button-outlined mb-2" icon="pi pi-filter-slash" (click)="clear(dataTable)"></button>

                <div class="flex flex-wrap gap-2 mb-2">
                    <div class="flex">
                        <input pInputText type="text" #filter (input)="onGlobalFilter(dataTable, $event)"
                               i18n-placeholder placeholder="Search Keyword" class="w-full"/>
                    </div>

                    <button *ngIf="selectedTag" (click)="onCreateTag.emit()" pButton class="p-button-outlined flex w-full sm:w-auto flex-order-0 sm:flex-order-1" icon="pi pi-tag"
                            i18n-label label="Edit Selected Tag"></button>

                    <button (click)="onCreateTag.emit()" pButton class="flex w-full sm:w-auto flex-order-0 sm:flex-order-1" icon="pi pi-tag"
                            i18n-label label="Create Tag From Filters"></button>

                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="min-width: 14rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Image</span>
                        <p-columnFilter type="text" field="metadata.image" display="menu"
                                        [matchModeOptions]="urlMatchModeOptions"
                                        i18n-placeholder placeholder="Search by image"></p-columnFilter>
                    </div>
                </th>

                <th style="min-width: 12rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Title</span>
                        <p-columnFilter type="text" field="metadata.title" display="menu" locale="fr" localeMatcher="lookup"
                                        [matchModeOptions]="textMatchModeOptions"
                                        i18n-placeholder placeholder="Search by title"></p-columnFilter>
                    </div>
                </th>
                <th style="min-width: 12rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Description</span>
                        <p-columnFilter type="text" field="metadata.description" display="menu"
                                        [matchModeOptions]="textMatchModeOptions"
                                        i18n-placeholder placeholder="Search by description"></p-columnFilter>
                    </div>
                </th>

                <th pSortableColumn="metadata.publishedAt" style="min-width: 10rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Publication</span>
                        <p-sortIcon field="metadata.publishedAt"></p-sortIcon>
                        <p-columnFilter type="date" field="metadata.publishedAt" display="menu" i18n-placeholder placeholder="dd/mm/yyyy"></p-columnFilter>
                    </div>
                </th>
                <th style="min-width: 10rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Categories</span>
                        <p-columnFilter field="metadata.categories"
                                        [matchModeOptions]="exactMatchModeOptions" matchMode="equals"
                                        [showOperator]="categories.length > 1" [maxConstraints]="categories.length"
                                        display="menu">

                            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                <p-dropdown [ngModel]="value" [options]="categories" (onChange)="filter($event.value)"
                                            i18n-placeholder placeholder="Any" [style]="{'min-width': '12rem'}" >
                                    <ng-template let-option pTemplate="item">
                                        {{ option }}
                                    </ng-template>
                                </p-dropdown>
                            </ng-template>
                        </p-columnFilter>
                    </div>
                </th>
                <th style="min-width: 10rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Feeds</span>
                        <p-columnFilter field="feeds" type="array" display="menu"
                                        matchMode="equals" [showMatchModes]="true"
                                        [maxConstraints]="feeds.length">

                            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                <p-dropdown [ngModel]="value" [options]="feeds" (onChange)="filter($event.value)"
                                            optionLabel="displayName" optionValue="displayName"
                                            i18n-placeholder placeholder="Any" [style]="{'min-width': '12rem'}" >
                                    <ng-template let-option pTemplate="item">
                                        {{ option.displayName }}
                                    </ng-template>
                                </p-dropdown>
                            </ng-template>


                        </p-columnFilter>
                    </div>
                </th>
                <th style="min-width: 12rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Tags</span>
                        <!--<p-columnFilter field="tags" matchMode="equals" display="menu">
                            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                <p-dropdown [ngModel]="value" [options]="[]" (onChange)="filter($event.value)"
                                            i18n-placeholder placeholder="Any" [style]="{'min-width': '12rem'}" >
                                    <ng-template let-option pTemplate="item">
                                        {{ option.displayName }}
                                    </ng-template>
                                </p-dropdown>
                            </ng-template>

                        </p-columnFilter> -->
                    </div>
                </th>
                <!--
                <th pSortableColumn="stats.popularity" style="min-width: 12rem">
                    <div class="flex justify-content-between align-items-center">
                        <span i18n>Popularity</span>
                        <p-sortIcon field="stats.popularity"></p-sortIcon>
                        <p-columnFilter field="popularity" matchMode="between" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
                            <ng-template pTemplate="filter" let-filter="filterCallback">
                                <p-slider [ngModel]="activityValues" [range]="true" (onSlideEnd)="filter($event.values)"
                                          styleClass="m-3" [style]="{'min-width': '12rem'}" ></p-slider>
                                <div class="flex align-items-center justify-content-between px-2">
                                    <span>{{activityValues[0]}}</span>
                                    <span>{{activityValues[1]}}</span>
                                </div>
                            </ng-template>
                        </p-columnFilter>
                    </div>
                </th> -->
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="text-center" i18n>No articles found.</td>
            </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
            <tr *ngFor="let k of [1,2,3]">
                <td>
                    <p-skeleton width="100%" height="5rem"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="100%" height="2rem"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="100%" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="100%" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="100%"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="100%"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="33%" styleClass="mx-auto"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="33%" styleClass="mx-auto"></p-skeleton>
                </td>
                <td>
                    <p-skeleton width="100%" height="1.5rem"></p-skeleton>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-article>
            <tr>
                <td style="padding: 0;">
                    <img [src]="article.metadata.image" alt="" class="w-full" [title]="article.metadata.image" style="vertical-align: middle"/>
                </td>
                <td>
                    <b>{{ article.metadata.title }}</b>
                </td>
                <td>
                    {{ article.metadata.description }}
                </td>
                <td>
                    {{ article.metadata.publishedAt | date: 'dd/MM/yyyy'}}
                    {{ article.metadata.publishedAt | date: 'HH:mm'}}
                </td>
                <td class="text-center">
                    <p-chip *ngFor="let category of article.metadata.categories" [label]="category" class="inline-block m-1"></p-chip>
                </td>
                <td class="text-center">
                    <p-chip *ngFor="let feed of article.feeds" [label]="feed" class="inline-block m-1"></p-chip>
                </td>
                <td class="text-center">
                    <p-tag *ngFor="let tag of article.tags"
                           (click)="loadTagById(tag)"
                           [severity]="getTagSeverity(tag)"
                           [value]="getTagDisplayName(tag)" class="inline-block m-1 cursor-pointer"></p-tag>
                </td>
                <!--<td>
                    <p-progressBar [value]="article.stats.clicked / article.stats.displayed * 100"
                                   [showValue]="false" [style]="{'height': '1.5rem'}"></p-progressBar>
                </td>-->
            </tr>
        </ng-template>
    </p-table>
</div>
